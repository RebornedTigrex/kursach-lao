<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание факультета</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            background-color: #f5f5f5;
            color: #333333;
        }

        /* Сайдбар */
        .sidebar {
            width: 250px;
            height: 100vh;
            background: linear-gradient(to bottom, #6a5acd, #9370db);
            color: white;
            position: fixed;
            transition: all 0.3s;
            transform: translateX(0);
            z-index: 100;
        }

        .sidebar.collapsed {
            transform: translateX(-200px);
        }

        .logo {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar ul {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .sidebar li i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .sidebar li:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar li.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 3px solid white;
        }

        .toggle-sidebar {
            position: absolute;
            right: 10px;
            top: 20px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Основное содержимое */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
            transition: all 0.3s;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 50px;
            width: calc(100% - 50px);
        }

        /* Недельный селектор */
        .week-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .week-selector button {
            background-color: #6a5acd;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            margin: 0 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .week-selector button:hover {
            background-color: #483d8b;
        }

        .current-week {
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Таблица расписания */
        .timetable {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .timetable th, .timetable td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .timetable th {
            background-color: #6a5acd;
            color: white;
            font-weight: 500;
        }

        .timetable .time {
            background-color: #f0f0f0;
            font-weight: 500;
        }

        .timetable .lesson {
            background-color: #e6e6fa;
            cursor: pointer;
            transition: background 0.2s;
            height: 60px;
        }

        .timetable .lesson:hover {
            background-color: #d8bfd8;
        }

        .timetable .lesson-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .timetable .break {
            background-color: #f9f9f9;
            color: #666;
            font-size: 0.9rem;
        }

        .timetable .break td {
            padding: 5px;
        }

        /* Модальное окно */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: #6a5acd;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-primary {
            background-color: #6a5acd;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: #483d8b;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <!-- Сайдбар -->
    <div class="sidebar">
        <div class="logo">Расписание Факультета</div>
        <button class="toggle-sidebar"><i class="fas fa-bars"></i></button>
        <ul>
            <li class="active"><i class="fas fa-calendar-alt"></i> Расписание</li>
            <li><i class="fas fa-book"></i> Предметы</li>
            <li><i class="fas fa-chalkboard-teacher"></i> Преподаватели</li>
            <li><i class="fas fa-building"></i> Аудитории</li>
            <li><i class="fas fa-cog"></i> Настройки</li>
        </ul>
    </div>

    <!-- Основное содержимое -->
    <div class="main-content">
        <!-- Селектор недели -->
        <div class="week-selector">
            <button class="prev-week"><i class="fas fa-chevron-left"></i></button>
            <span class="current-week">12-18 Сентября 2023</span>
            <button class="next-week"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Таблица расписания -->
        <table class="timetable">
            <thead>
                <tr>
                    <th>Время</th>
                    <th>Понедельник</th>
                    <th>Вторник</th>
                    <th>Среда</th>
                    <th>Четверг</th>
                    <th>Пятница</th>
                    <th>Суббота</th>
                </tr>
            </thead>
            <tbody>
                <!-- 1 пара -->
                <tr>
                    <td class="time">09:00 - 10:30</td>
                    <td class="lesson" data-day="mon" data-time="09:00">
                        <div class="lesson-content">Математика<br>Ауд. 304</div>
                    </td>
                    <td class="lesson" data-day="tue" data-time="09:00"></td>
                    <td class="lesson" data-day="wed" data-time="09:00">
                        <div class="lesson-content">Физика<br>Ауд. 201</div>
                    </td>
                    <td class="lesson" data-day="thu" data-time="09:00"></td>
                    <td class="lesson" data-day="fri" data-time="09:00">
                        <div class="lesson-content">Программирование<br>Ауд. 105</div>
                    </td>
                    <td class="lesson" data-day="sat" data-time="09:00"></td>
                </tr>
                
                <!-- Перерыв 10 мин -->
                <tr class="break">
                    <td>10:30 - 10:40</td>
                    <td colspan="6">Перерыв</td>
                </tr>
                
                <!-- 2 пара -->
                <tr>
                    <td class="time">10:40 - 12:10</td>
                    <td class="lesson" data-day="mon" data-time="10:40"></td>
                    <td class="lesson" data-day="tue" data-time="10:40">
                        <div class="lesson-content">Английский язык<br>Ауд. 203</div>
                    </td>
                    <td class="lesson" data-day="wed" data-time="10:40"></td>
                    <td class="lesson" data-day="thu" data-time="10:40">
                        <div class="lesson-content">История<br>Ауд. 401</div>
                    </td>
                    <td class="lesson" data-day="fri" data-time="10:40"></td>
                    <td class="lesson" data-day="sat" data-time="10:40"></td>
                </tr>
                
                <!-- Перерыв 30 мин -->
                <tr class="break">
                    <td>12:10 - 12:40</td>
                    <td colspan="6">Большой перерыв</td>
                </tr>
                
                <!-- 3 пара -->
                <tr>
                    <td class="time">12:40 - 14:10</td>
                    <td class="lesson" data-day="mon" data-time="12:40">
                        <div class="lesson-content">Базы данных<br>Ауд. 305</div>
                    </td>
                    <td class="lesson" data-day="tue" data-time="12:40"></td>
                    <td class="lesson" data-day="wed" data-time="12:40"></td>
                    <td class="lesson" data-day="thu" data-time="12:40"></td>
                    <td class="lesson" data-day="fri" data-time="12:40">
                        <div class="lesson-content">Алгоритмы<br>Ауд. 108</div>
                    </td>
                    <td class="lesson" data-day="sat" data-time="12:40"></td>
                </tr>
                
                <!-- Перерыв 10 мин -->
                <tr class="break">
                    <td>14:10 - 14:20</td>
                    <td colspan="6">Перерыв</td>
                </tr>
                
                <!-- 4 пара -->
                <tr>
                    <td class="time">14:20 - 15:50</td>
                    <td class="lesson" data-day="mon" data-time="14:20"></td>
                    <td class="lesson" data-day="tue" data-time="14:20">
                        <div class="lesson-content">Физкультура<br>Спортзал</div>
                    </td>
                    <td class="lesson" data-day="wed" data-time="14:20"></td>
                    <td class="lesson" data-day="thu" data-time="14:20">
                        <div class="lesson-content">Философия<br>Ауд. 302</div>
                    </td>
                    <td class="lesson" data-day="fri" data-time="14:20"></td>
                    <td class="lesson" data-day="sat" data-time="14:20"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Модальное окно редактирования -->
    <div class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Редактирование пары</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Предмет:</label>
                    <select class="subject-select">
                        <option value="">-- Выберите предмет --</option>
                        <option value="1">Математика</option>
                        <option value="2">Физика</option>
                        <option value="3">Программирование</option>
                        <option value="4">Базы данных</option>
                        <option value="5">Английский язык</option>
                        <option value="6">История</option>
                        <option value="7">Алгоритмы</option>
                        <option value="8">Физкультура</option>
                        <option value="9">Философия</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Аудитория:</label>
                    <select class="room-select">
                        <option value="">-- Выберите аудиторию --</option>
                        <option value="101">Ауд. 101</option>
                        <option value="105">Ауд. 105</option>
                        <option value="108">Ауд. 108</option>
                        <option value="201">Ауд. 201</option>
                        <option value="203">Ауд. 203</option>
                        <option value="302">Ауд. 302</option>
                        <option value="304">Ауд. 304</option>
                        <option value="305">Ауд. 305</option>
                        <option value="401">Ауд. 401</option>
                        <option value="sport">Спортзал</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Преподаватель:</label>
                    <select class="teacher-select">
                        <option value="">-- Выберите преподавателя --</option>
                        <option value="1">Иванов А.А.</option>
                        <option value="2">Петрова С.И.</option>
                        <option value="3">Сидоров В.М.</option>
                        <option value="4">Кузнецова О.П.</option>
                        <option value="5">Смирнов Д.В.</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger clear-btn">Удалить пару</button>
                <button class="btn btn-secondary cancel-btn">Отмена</button>
                <button class="btn btn-primary save-btn">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
    // Глобальные переменные для хранения состояния
    let selectedDay = null;
    let selectedTime = null;
    let selectedCell = null;
    let currentGroupId = 1; // ID группы по умолчанию
    let currentWeekOffset = 0; // Смещение недели

    // DOM элементы
    const weekSelector = document.querySelector('.current-week');
    const prevWeekBtn = document.querySelector('.prev-week');
    const nextWeekBtn = document.querySelector('.next-week');
    const modalOverlay = document.querySelector('.modal-overlay');
    const modalCloseBtn = document.querySelector('.modal-close');
    const cancelBtn = document.querySelector('.cancel-btn');
    const saveBtn = document.querySelector('.save-btn');
    const clearBtn = document.querySelector('.clear-btn');
    const subjectSelect = document.querySelector('.subject-select');
    const roomSelect = document.querySelector('.room-select');
    const teacherSelect = document.querySelector('.teacher-select');

    // Функция для загрузки расписания
    async function loadSchedule(groupId = currentGroupId, weekOffset = currentWeekOffset) {
        try {
            const response = await fetch(`http://localhost:8000/groups/${groupId}/schedule/?week_offset=${weekOffset}`);
            if (!response.ok) throw new Error('Ошибка загрузки расписания');
            
            const data = await response.json();
            
            // Очищаем текущее расписание
            document.querySelectorAll('.lesson').forEach(cell => {
                cell.innerHTML = '';
            });
            
            // Заполняем расписание из данных API
            data.schedules.forEach(lesson => {
                const dayCell = document.querySelector(`.lesson[data-day="${lesson.day_of_week}"][data-time="${lesson.start_time}"]`);
                if (dayCell) {
                    dayCell.innerHTML = `
                        <div class="lesson-content">
                            ${lesson.subject.name}<br>
                            Ауд. ${lesson.classroom.number}<br>
                            ${lesson.teacher.full_name}
                        </div>
                    `;
                    // Сохраняем ID занятия в data-атрибут
                    dayCell.dataset.scheduleId = lesson.id;
                }
            });
            
            // Обновляем отображение текущей недели
            updateWeekDisplay(weekOffset);
        } catch (error) {
            console.error('Error loading schedule:', error);
            alert('Не удалось загрузить расписание');
        }
    }

    // Функция для обновления отображения недели
    function updateWeekDisplay(weekOffset) {
        const weeks = [
            "12-18 Сентября 2023",
            "19-25 Сентября 2023",
            "26 Сентября - 2 Октября 2023",
            "3-9 Октября 2023"
        ];
        
        const index = Math.max(0, Math.min(weekOffset + 1, weeks.length - 1));
        weekSelector.textContent = weeks[index];
    }

    // Функция для открытия модального окна
    function openModal(cell) {
        selectedCell = cell;
        selectedDay = cell.dataset.day;
        selectedTime = cell.dataset.time;
        
        // Сбрасываем значения в форме
        subjectSelect.value = '';
        roomSelect.value = '';
        teacherSelect.value = '';
        
        // Если в ячейке уже есть занятие, заполняем форму
        if (cell.dataset.scheduleId) {
            // Здесь можно добавить загрузку данных существующего занятия
            // и заполнить форму соответствующими значениями
        }
        
        modalOverlay.classList.add('active');
    }

    // Функция для закрытия модального окна
    function closeModal() {
        modalOverlay.classList.remove('active');
        selectedCell = null;
        selectedDay = null;
        selectedTime = null;
    }

    // Функция для сохранения занятия
    async function saveLesson() {
        if (!subjectSelect.value || !roomSelect.value || !teacherSelect.value) {
            alert('Пожалуйста, заполните все поля');
            return;
        }

        try {
            const response = await fetch('http://localhost:8000/schedules/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    day_of_week: parseInt(selectedDay),
                    start_time: selectedTime,
                    end_time: calculateEndTime(selectedTime),
                    group_id: currentGroupId,
                    subject_id: parseInt(subjectSelect.value),
                    teacher_id: parseInt(teacherSelect.value),
                    classroom_id: parseInt(roomSelect.value) || roomSelect.value // для спортзала
                })
            });
            
            if (!response.ok) throw new Error('Ошибка сохранения');
            
            const data = await response.json();
            
            // Обновляем ячейку с новым занятием
            if (selectedCell) {
                selectedCell.innerHTML = `
                    <div class="lesson-content">
                        ${subjectSelect.options[subjectSelect.selectedIndex].text}<br>
                        Ауд. ${roomSelect.options[roomSelect.selectedIndex].text}<br>
                        ${teacherSelect.options[teacherSelect.selectedIndex].text}
                    </div>
                `;
                selectedCell.dataset.scheduleId = data.id;
            }
            
            closeModal();
        } catch (error) {
            console.error('Error saving schedule:', error);
            alert('Не удалось сохранить занятие');
        }
    }

    // Функция для удаления занятия
    async function deleteLesson() {
        if (!selectedCell || !selectedCell.dataset.scheduleId) {
            alert('Нет занятия для удаления');
            return;
        }

        if (!confirm('Вы уверены, что хотите удалить это занятие?')) return;

        try {
            const response = await fetch(`http://localhost:8000/schedules/${selectedCell.dataset.scheduleId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) throw new Error('Ошибка удаления');
            
            // Очищаем ячейку
            selectedCell.innerHTML = '';
            delete selectedCell.dataset.scheduleId;
            
            closeModal();
        } catch (error) {
            console.error('Error deleting schedule:', error);
            alert('Не удалось удалить занятие');
        }
    }

    // Вспомогательная функция для расчета времени окончания пары
    function calculateEndTime(startTime) {
        const [hours, minutes] = startTime.split(':').map(Number);
        const startDate = new Date();
        startDate.setHours(hours, minutes, 0, 0);
        
        // Добавляем 1.5 часа (90 минут) к времени начала
        startDate.setMinutes(startDate.getMinutes() + 90);
        
        // Форматируем время в HH:MM
        return `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        // Загрузка расписания
        loadSchedule();
        
        // Обработчики для ячеек расписания
        document.querySelectorAll('.lesson').forEach(cell => {
            cell.addEventListener('click', () => openModal(cell));
        });
        
        // Навигация по неделям
        prevWeekBtn.addEventListener('click', () => {
            currentWeekOffset = Math.max(currentWeekOffset - 1, 0);
            loadSchedule(currentGroupId, currentWeekOffset);
        });
        
        nextWeekBtn.addEventListener('click', () => {
            currentWeekOffset += 1;
            loadSchedule(currentGroupId, currentWeekOffset);
        });
        
        // Модальное окно
        modalCloseBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        saveBtn.addEventListener('click', saveLesson);
        clearBtn.addEventListener('click', deleteLesson);
        
        // Закрытие модального окна при клике на оверлей
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeModal();
        });
    });
</script>
</body>
</html>